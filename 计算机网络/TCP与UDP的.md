# TCP与UDP

## TCP与UDP区别

TCP和UDP都是网络传输层的协议，其主要区别如下：

1. TCP需要建立连接，是面向连接的，而UDP是无需连接的（不需要握手过程）。
2. TCP提供可靠的服务，传输的数据无差错不丢失不重复，TCP会通过校验和、重传控制、序号标识、滑动窗口、确认应答等实现可靠传输，丢包时会重发，还可对包进行次序控制。UDP的头部数据比较少，因此UDP不保证可靠交付。
3. UDP具有较好的实时性。
4. TCP连接是点到点的，而UDP支持一对一、一对多、多对一、多对多的交互通信
5. TCP对资源要求较多，UDP对系统资源要求较少

## TCP协议详解

### TCP报文
TCP报文格式如下：
![TCP报文](https://upload-images.jianshu.io/upload_images/2964446-ab077ff3902529a3.jpg)

其简介如下，可做参考：

16位源端口号：16位的源端口中包含初始化通信的端口。源端口和源IP地址的作用是标识报文的返回地址。

16位目的端口号：16位的目的端口域定义传输的目的。这个端口指明报文接收计算机上的应用程序地址接口。

32位序号：32位的序列号由接收端计算机使用，重新分段的报文成最初形式。当SYN出现，序列码实际上是初始序列码（Initial Sequence Number，ISN），而第一个数据字节是ISN+1。这个序列号（序列码）可用来补偿传输中的不一致。

32位确认序号：32位的序列号由接收端计算机使用，重组分段的报文成最初形式。如果设置了ACK控制位，这个值表示一个准备接收的包的序列码。

4位首部长度：4位包括TCP头大小，指示何处数据开始。

保留（6位）：6位值域，这些位必须是0。为了将来定义新的用途而保留。

标志：6位标志域。表示为：紧急标志、有意义的应答标志、推、重置连接标志、同步序列号标志、完成发送数据标志。按照顺序排列是：URG、ACK、PSH、RST、SYN、FIN。

16位窗口大小：用来表示想收到的每个TCP数据段的大小。TCP的流量控制由连接的每一端通过声明的窗口大小来提供。窗口大小为字节数，起始于确认序号字段指明的值，这个值是接收端正期望接收的字节。窗口大小是一个16字节字段，因而窗口大小最大为65535字节。

16位校验和：16位TCP头。源机器基于数据内容计算一个数值，收信息机要与源机器数值 结果完全一样，从而证明数据的有效性。检验和覆盖了整个的TCP报文段：这是一个强制性的字段，一定是由发送端计算和存储，并由接收端进行验证的。

16位紧急指针：指向后面是优先数据的字节，在URG标志设置了时才有效。如果URG标志没有被设置，紧急域作为填充。加快处理标示为紧急的数据段。

选项：长度不定，但长度必须为1个字节。如果没有选项就表示这个1字节的域等于0。

数据：该TCP协议包负载的数据。

在上述字段中，6位标志域的各个选项功能如下。

URG：紧急标志。紧急标志为"1"表明该位有效。
ACK：确认标志。表明确认编号栏有效。大多数情况下该标志位是置位的。TCP报头内的确认编号栏内包含的确认编号（w+1）为下一个预期的序列编号，同时提示远端系统已经成功接收所有数据。
PSH：推标志。该标志置位时，接收端不将该数据进行队列处理，而是尽可能快地将数据转由应用处理。在处理Telnet或rlogin等交互模式的连接时，该标志总是置位的。
RST：复位标志。用于复位相应的TCP连接。
SYN：同步标志。表明同步序列编号栏有效。该标志仅在三次握手建立TCP连接时有效。它提示TCP连接的服务端检查序列编号，该序列编号为TCP连接初始端（一般是客户端）的初始序列编号。在这里，可以把TCP序列编号看作是一个范围从0到4，294，967，295的32位计数器。通过TCP连接交换的数据中每一个字节都经过序列编号。在TCP报头中的序列编号栏包括了TCP分段中第一个字节的序列编号。
FIN：结束标志。

### TCP的三次握手

TCP建立连接需要三次握手，其示例图如下：

![三次握手](https://upload-images.jianshu.io/upload_images/2964446-aa923712d5218eeb.png)

其简单过程如下：

1. 客户端发送一个随机值给服务端，并将同步标志SYN置为1，此时客户端进入等待状态；
2. 服务端收到客户端发送的随机值后，将该值+1 ，作为响应值，并将ACK置为1，同时产生一个随机值，和同步标志一起发送回客户端，此时服务端进入等待状态；
3. 客户端收到相应后，发送确认ACK为1，将服务端发送来的随机值+1返回给服务端，表示链接可以建立，此时客户端和服务端进入建立连接状态发送数据

### TCP的四次挥手

TCP断开连接需要四次挥手，其示例图如下：

![四次挥手](https://upload-images.jianshu.io/upload_images/2964446-2b9562b3a8b72fb2.png)

其简单过程如下：

1. 客户端发送一个FIN请求和一个随机数给服务端
2. 服务端收到该请求之后，将随机数+1 和 ACK=1一同发送给客户端
3. 服务端发送一个FIN请求个一个随机数给客户端，客户端进入TIME_WAIT状态
4. 客户端收到该请求之后，将随机数+1 和 ACK=1一同发送给服务端

TIME_WAIT状态主要作用如下：
1. 保证TCP协议下服务端和客户端都能可靠关闭
2. 保证这次连接的重复数据段从网络中消失